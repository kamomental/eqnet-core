name: CI

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
      - name: Install schema tooling
        run: pip install jsonschema

      - name: Validate runtime config schema
        run: |
          python - <<'PY'
          import yaml, sys
          path = "config/runtime.yaml"
          with open(path, encoding="utf-8") as f:
              data = yaml.safe_load(f) or {}
          for key in ("ignition", "telemetry"):
              if key not in data:
                  raise SystemExit(f"{path} missing '{key}' key")
          print("runtime.yaml keys OK")
          PY

      - name: Generate telemetry sample
        run: |
          python scripts/run_quick_loop.py \
            --steps 20 \
            --field_metrics_log tests/fixtures/golden/field_metrics.jsonl \
            --telemetry_log telemetry/ci-run.jsonl

      - name: Run tests with coverage
        run: |
          pytest -q --cov=emot_terrain_lab --cov=devlife --maxfail=1

      - name: Validate fast-path config
        run: python tools/validate_config.py config/fastpath.yaml

      - name: Run nightly summary
        run: python -m emot_terrain_lab.ops.nightly --telemetry_log telemetry/ci-run.jsonl

      - name: Validate nightly JSON schema
        run: |
          python - <<'PY'
          import json, jsonschema
          from pathlib import Path
          data = json.loads(Path("reports/nightly.json").read_text(encoding="utf-8"))
          schema = json.loads(Path("schema/nightly.v1.json").read_text(encoding="utf-8"))
          jsonschema.validate(instance=data, schema=schema)
          print("[CI] nightly.json schema OK")
          PY

      - name: Monument floor regression
        run: |
          python - <<'PY'
          import json
          from pathlib import Path
          import yaml
          from ops import nightly
          from emot_terrain_lab.hub.hub import Hub

          cfg = yaml.safe_load(Path("config/runtime.yaml").read_text(encoding="utf-8")) or {}
          forgetting = cfg.get("forgetting") or {}
          forgetting["monument_floor_test"] = True
          cfg["forgetting"] = forgetting
          hub = Hub(cfg)
          report = nightly.run(hub, cfg)
          payload = json.loads(Path("reports/nightly.json").read_text(encoding="utf-8"))
          forgetting = payload.get("forgetting") or {}
          if forgetting.get("status") != "applied":
              raise SystemExit(f"[CI] forgetting not applied: {forgetting}")
          source_counts = forgetting.get("source_counts") or {}
          if source_counts.get("hub", 0) <= 0 or source_counts.get("heart_os_session", 0) <= 0:
              raise SystemExit(f"[CI] invalid source_counts: {source_counts}")
          test = payload.get("monument_floor_test") or report.get("monument_floor_test") or {}
          if test.get("status") != "applied":
              raise SystemExit(f"[CI] monument_floor_test not applied: {test}")
          for key in ("delta_p_min", "delta_p_mean", "delta_p_max"):
              if key not in test:
                  raise SystemExit(f"[CI] missing {key} in monument_floor_test")
          print("[CI] monument_floor_test OK")
          PY

      - name: Check nightly plot links
        run: |
          python - <<'PY'
          import pathlib, re, sys
          md_path = pathlib.Path("reports/nightly.md")
          if not md_path.exists():
              raise SystemExit("reports/nightly.md not found")
          content = md_path.read_text(encoding="utf-8")
          paths = re.findall(r'!\[[^\]]*\]\((reports/plots/[^)]+)\)', content)
          missing = [p for p in paths if not pathlib.Path(p).exists()]
          if missing:
              print("[CI] Missing plot files:", missing)
              sys.exit(1)
          print("[CI] nightly.md plot links OK:", paths)
          PY

      - name: Check resonance history
        run: |
          if [ -f reports/resonance_history.jsonl ]; then
            python - <<'PY'
import json, pathlib, sys
hist = pathlib.Path("reports/resonance_history.jsonl")
if hist.stat().st_size == 0:
    raise SystemExit("resonance_history.jsonl is empty")
valid = False
for line in hist.read_text(encoding="utf-8").splitlines():
    if not line.strip():
        continue
    try:
        row = json.loads(line)
    except json.JSONDecodeError:
        continue
    if "objective" in row:
        valid = True
        break
if not valid:
    raise SystemExit("resonance_history.jsonl contains no objective entries")
print("[CI] resonance history ok")
PY
          fi

      - name: Dry-run tuning application
        run: |
          python scripts/apply_nightly_tuning.py \
            --nightly reports/nightly.json \
            --config config/runtime.yaml || true
      - name: Generate PR nightly summary
        if: github.event_name == 'pull_request'
        run: |
          python scripts/summarize_nightly.py \
            --json reports/nightly.json \
            --out pr-summary.txt \
            --delta-threshold 0.01

      - name: Comment PR with nightly summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const core = require('@actions/core');
            const path = 'pr-summary.txt';
            if (!fs.existsSync(path)) {
              core.info('No nightly summary found; skipping comment.');
              return;
            }
            const body = fs.readFileSync(path, 'utf8').trim();
            if (!body) {
              core.info('Nightly summary empty; skipping comment.');
              return;
            }
            const marker = '### Nightly サマリ';
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              per_page: 100
            });
            const existing = comments.find(comment =>
              comment.user &&
              comment.user.login === 'github-actions[bot]' &&
              comment.body &&
              comment.body.startsWith(marker)
            );
            if (existing) {
              if (existing.body.trim() === body.trim()) {
                core.info('Nightly summary unchanged; skipping update.');
                return;
              }
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }

      - name: Upload nightly artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-report
          path: |
            reports/nightly.md
            reports/plots/*.png
            telemetry/**/*.jsonl
          if-no-files-found: warn

