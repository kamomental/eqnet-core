<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="{{ url_for('static', path='observer.css') }}" />
    <title>EQNet Observer</title>
  </head>
  <body>
    <main class="page">
      <header class="page__header">
        <h1>EQNet Observer</h1>
        <a href="/overlay/latest" target="_blank" rel="noreferrer">OBS overlay</a>
      </header>
      <section>
        <table class="audits">
          <thead>
            <tr>
              <th>Date</th>
              <th>Status</th>
              <th>Fatal</th>
              <th>Warn rate</th>
              <th>Top reasons</th>
              <th>Hint categories</th>
              <th>Blocked by category</th>
            </tr>
          </thead>
          <tbody>
            {% for audit in audits %}
              <tr>
                <td>{{ audit.date }}</td>
                <td>{{ audit.health.status }}</td>
                <td>{{ audit.summary.fatal_failures }}</td>
                <td>{{ audit.summary.warn_fail_rate }}</td>
                <td>
                  {% for reason in audit.summary.top_reasons %}
                    <div>{{ reason.get("reason") or reason.get("message") }}</div>
                  {% endfor %}
                </td>
                <td>
                  {% set categories = audit.summary.memory_hint.category_topk %}
                  {% set no_data = audit.summary.memory_hint.no_data_label or '-' %}
                  {% if categories %}
                    {% for pair in categories %}
                      <div>{{ pair[0] }} ({{ pair[1] }})</div>
                    {% endfor %}
                  {% else %}
                    <div>{{ no_data }}</div>
                  {% endif %}
                </td>
                <td>
                  {% set blocked = audit.summary.memory_hint.category_blocked_reason %}
                  {% if blocked %}
                    {% for category, reasons in blocked|dictsort %}
                      <div>
                        {{ category }}:
                        {% if reasons %}
                          {% for reason, count in reasons|dictsort %}
                            {{ reason }} ({{ count }}){% if not loop.last %}, {% endif %}
                          {% endfor %}
                        {% else %}
                          {{ no_data }}
                        {% endif %}
                      </div>
                    {% endfor %}
                  {% else %}
                    <div>{{ no_data }}</div>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </section>
    </main>
  </body>
</html>
